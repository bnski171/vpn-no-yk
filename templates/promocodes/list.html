{% extends "base.html" %}

{% block title %}–ü—Ä–æ–º–æ–∫–æ–¥—ã - VPN Admin Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã</h2>
    <div>
        <a href="/admin/promocodes/add" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</a>
        <button onclick="bulkCreatePromocodes()" class="btn btn-warning">üì¶ –ú–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</button>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 25px;">
    <div class="stat-card">
        <div class="stat-value">{{ promocodes|length }}</div>
        <div>–í—Å–µ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ promocodes_stats.active_count }}</div>
        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ promocodes_stats.total_activations }}</div>
        <div>–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ promocodes_stats.available_activations }}</div>
        <div>–î–æ—Å—Ç—É–ø–Ω–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π</div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">üîç –§–∏–ª—å—Ç—Ä—ã</div>
    <form method="GET" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>–ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É</label>
            <input type="text" name="search" class="form-control" value="{{ request.args.get('search', '') }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select name="status" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="exhausted" {% if request.args.get('status') == 'exhausted' %}selected{% endif %}>–ò—Å—á–µ—Ä–ø–∞–Ω–Ω—ã–µ</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
            <select name="duration" class="form-control">
                <option value="">–õ—é–±–∞—è</option>
                <option value="3600" {% if request.args.get('duration') == '3600' %}selected{% endif %}>1 —á–∞—Å</option>
                <option value="86400" {% if request.args.get('duration') == '86400' %}selected{% endif %}>1 –¥–µ–Ω—å</option>
                <option value="604800" {% if request.args.get('duration') == '604800' %}selected{% endif %}>7 –¥–Ω–µ–π</option>
                <option value="2592000" {% if request.args.get('duration') == '2592000' %}selected{% endif %}>30 –¥–Ω–µ–π</option>
            </select>
        </div>
        
        <button type="submit" class="btn">üîç –ü–æ–∏—Å–∫</button>
    </form>
</div>

<!-- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
<div class="card">
    <div class="card-header">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>
    
    {% if promocodes %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>–ö–æ–¥</th>
                    <th>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                    <th>–ê–∫—Ç–∏–≤–∞—Ü–∏–∏</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for promo in promocodes %}
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <strong style="font-family: monospace; font-size: 16px;">{{ promo.code }}</strong>
                            <button onclick="copyToClipboard('{{ promo.code }}')" class="btn" style="padding: 2px 6px; font-size: 10px;">
                                üìã
                            </button>
                        </div>
                    </td>
                    <td>
                        <strong>{{ promo.duration_human }}</strong><br>
                        <small style="color: #6c757d; font-family: monospace;">{{ promo.duration_seconds }} —Å–µ–∫</small>
                    </td>
                    <td>
                        <div style="text-align: center;">
                            <div style="font-size: 18px; font-weight: bold;">
                                {{ promo.current_activations }} / {{ promo.max_activations }}
                            </div>
                            <div style="background: #e9ecef; border-radius: 10px; height: 6px; margin: 5px 0;">
                                {% set percentage = (promo.current_activations / promo.max_activations * 100) if promo.max_activations > 0 else 0 %}
                                <div style="background: {% if percentage < 70 %}#28a745{% elif percentage < 90 %}#ffc107{% else %}#dc3545{% endif %}; 
                                           width: {{ percentage }}%; height: 100%; border-radius: 10px; transition: width 0.3s ease;"></div>
                            </div>
                            <small style="color: #6c757d;">
                                –û—Å—Ç–∞–ª–æ—Å—å: {{ promo.max_activations - promo.current_activations }}
                            </small>
                        </div>
                    </td>
                    <td>
                        {% if not promo.is_active %}
                            <span class="status status-expired">‚ùå –û—Ç–∫–ª—é—á–µ–Ω</span>
                        {% elif promo.current_activations >= promo.max_activations %}
                            <span class="status status-warning">‚ö†Ô∏è –ò—Å—á–µ—Ä–ø–∞–Ω</span>
                        {% else %}
                            <span class="status status-active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <span data-timestamp="{{ promo.created_at.isoformat() }}">
                            {{ promo.created_at.strftime('%d.%m.%Y %H:%M') }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button onclick="togglePromocodeStatus({{ promo.id }})" 
                                    class="btn {% if promo.is_active %}btn-secondary{% else %}btn-success{% endif %}" 
                                    style="padding: 4px 8px; font-size: 12px;">
                                {% if promo.is_active %}‚è∏Ô∏è –û—Ç–∫–ª—é—á–∏—Ç—å{% else %}‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å{% endif %}
                            </button>
                            
                            <button onclick="showPromocodeDetails({{ promo.id }})" 
                                    class="btn" style="padding: 4px 8px; font-size: 12px;">
                                üìä –î–µ—Ç–∞–ª–∏
                            </button>
                            
                            <form method="POST" action="/admin/promocodes/{{ promo.id }}/delete" 
                                  style="display: inline;" 
                                  onsubmit="return confirmDelete('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ {{ promo.code }}?')">
                                <button type="submit" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px;">
                                    üóëÔ∏è
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 60px; color: #6c757d;">
        <h3>üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        <a href="/admin/promocodes/add" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</a>
    </div>
    {% endif %}
</div>

<!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ -->
<div class="card">
    <div class="card-header">üé≤ –ë—ã—Å—Ç—Ä—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</div>
    
    <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <form method="POST" action="/admin/promocodes/quick-create" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>‚ö° 1 —á–∞—Å –¥–æ—Å—Ç—É–ø–∞</strong><br>
                <small>–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</small>
                <input type="hidden" name="duration_seconds" value="3600">
                <input type="hidden" name="max_activations" value="10">
                <button type="submit" class="btn btn-success" style="margin-top: 10px; width: 100%;">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/promocodes/quick-create" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>üìÖ 3 –¥–Ω—è –¥–æ—Å—Ç—É–ø–∞</strong><br>
                <small>–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                <input type="hidden" name="duration_seconds" value="259200">
                <input type="hidden" name="max_activations" value="50">
                <button type="submit" class="btn btn-success" style="margin-top: 10px; width: 100%;">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/promocodes/quick-create" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>üéÅ 7 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</strong><br>
                <small>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π</small>
                <input type="hidden" name="duration_seconds" value="604800">
                <input type="hidden" name="max_activations" value="25">
                <button type="submit" class="btn btn-warning" style="margin-top: 10px; width: 100%;">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/promocodes/quick-create" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>üíé 30 –¥–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</strong><br>
                <small>VIP –ø—Ä–æ–º–æ–∫–æ–¥</small>
                <input type="hidden" name="duration_seconds" value="2592000">
                <input type="hidden" name="max_activations" value="5">
                <button type="submit" class="btn btn-warning" style="margin-top: 10px; width: 100%;">
                    –°–æ–∑–¥–∞—Ç—å
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
<div id="promocodeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%;">
        <div id="modalContent">
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        <button onclick="closeModal()" class="btn btn-secondary" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
async function togglePromocodeStatus(promocodeId) {
    try {
        const response = await fetch(`/admin/promocodes/${promocodeId}/toggle`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

async function showPromocodeDetails(promocodeId) {
    try {
        const response = await fetch(`/admin/promocodes/${promocodeId}/details`);
        const result = await response.json();
        
        if (result.success) {
            const promo = result.promocode;
            const activations = result.activations;
            
            let activationsList = '';
            if (activations.length > 0) {
                activationsList = activations.map(activation => 
                    `<tr>
                        <td>${activation.user_telegram_id}</td>
                        <td>${activation.activated_at}</td>
                    </tr>`
                ).join('');
                activationsList = `
                    <h4>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–π:</h4>
                    <table class="table">
                        <thead>
                            <tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</th></tr>
                        </thead>
                        <tbody>${activationsList}</tbody>
                    </table>
                `;
            } else {
                activationsList = '<p style="color: #6c757d;">–ü—Ä–æ–º–æ–∫–æ–¥ –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è</p>';
            }
            
            document.getElementById('modalContent').innerHTML = `
                <h3>üéüÔ∏è –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ ${promo.code}</h3>
                <div style="display: grid; gap: 15px; margin: 20px 0;">
                    <div><strong>–ö–æ–¥:</strong> <span style="font-family: monospace; font-size: 16px;">${promo.code}</span></div>
                    <div><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${promo.duration_human} (${promo.duration_seconds} —Å–µ–∫)</div>
                    <div><strong>–ê–∫—Ç–∏–≤–∞—Ü–∏–π:</strong> ${promo.current_activations} –∏–∑ ${promo.max_activations}</div>
                    <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${promo.is_active ? '<span class="status status-active">–ê–∫—Ç–∏–≤–µ–Ω</span>' : '<span class="status status-expired">–û—Ç–∫–ª—é—á–µ–Ω</span>'}</div>
                    <div><strong>–°–æ–∑–¥–∞–Ω:</strong> ${promo.created_at}</div>
                </div>
                ${activationsList}
            `;
            
            document.getElementById('promocodeModal').style.display = 'block';
        } else {
            throw new Error(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ' + error.message);
    }
}

function closeModal() {
    document.getElementById('promocodeModal').style.display = 'none';
}

function bulkCreatePromocodes() {
    const count = prompt('–°–∫–æ–ª—å–∫–æ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å–æ–∑–¥–∞—Ç—å? (–º–∞–∫—Å–∏–º—É–º 100)');
    if (!count || isNaN(count) || count < 1 || count > 100) {
        alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 100');
        return;
    }
    
    const duration = prompt('–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 86400 –¥–ª—è 1 –¥–Ω—è):');
    if (!duration || isNaN(duration) || duration < 1) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥');
        return;
    }
    
    const maxActivations = prompt('–ú–∞–∫—Å–∏–º—É–º –∞–∫—Ç–∏–≤–∞—Ü–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞:');
    if (!maxActivations || isNaN(maxActivations) || maxActivations < 1) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–π');
        return;
    }
    
    if (!confirm(`–°–æ–∑–¥–∞—Ç—å ${count} –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–∞ ${Math.floor(duration/86400)} –¥–Ω–µ–π —Å ${maxActivations} –∞–∫—Ç–∏–≤–∞—Ü–∏—è–º–∏ –∫–∞–∂–¥—ã–π?`)) {
        return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/promocodes/bulk-create';
    
    const fields = {
        count: count,
        duration_seconds: duration,
        max_activations: maxActivations
    };
    
    for (const [key, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
document.getElementById('promocodeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}