{% extends "base.html" %}

{% block title %}–ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É - {{ user.telegram_id }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è {{ user.telegram_id }}</h2>
    <div>
        <a href="/admin/users/{{ user.id }}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</a>
        <a href="/admin/users" class="btn btn-secondary">üìã –ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</a>
    </div>
</div>

<div class="card-grid" style="grid-template-columns: 1fr 1fr;">
    <!-- –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å -->
    <div class="card">
        <div class="card-header">üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                <span style="font-family: monospace; font-size: 16px;">{{ user.telegram_id }}</span>
            </div>
            <div>
                <strong>Email:</strong><br>
                <span style="font-family: monospace; color: #6c757d;">{{ user.email }}</span>
            </div>
            <div>
                <strong>–°–µ—Ä–≤–µ—Ä:</strong><br>
                {% if user.server_name %}
                    <span class="status status-active">{{ user.server_name }}</span>
                {% else %}
                    <span class="status status-warning">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                {% endif %}
            </div>
            <div>
                <strong>–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong><br>
                <span style="font-size: 18px; font-weight: bold;">
                    {{ user.subscription_end.strftime('%d.%m.%Y %H:%M:%S') }}
                </span>
            </div>
            <div>
                <strong>–°—Ç–∞—Ç—É—Å:</strong><br>
                {% if user.is_subscription_active %}
                    <span class="status status-active">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span>
                {% else %}
                    <span class="status status-expired">‚ùå –ò—Å—Ç–µ–∫–ª–∞</span>
                {% endif %}
            </div>
            <div>
                <strong>–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏:</strong><br>
                {% set time_left = user.time_left_seconds %}
                {% if time_left > 0 %}
                    <span style="color: #28a745; font-weight: bold;">
                        {{ time_left // 86400 }} –¥–Ω {{ (time_left % 86400) // 3600 }} —á {{ ((time_left % 3600) // 60) }} –º–∏–Ω
                    </span><br>
                    <small style="font-family: monospace;">({{ time_left }} —Å–µ–∫—É–Ω–¥)</small>
                {% else %}
                    <span style="color: #dc3545; font-weight: bold;">–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ -->
    <div class="card">
        <div class="card-header">‚ö° –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</div>
        <div style="display: grid; gap: 15px;">
            <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <button type="submit" name="seconds" value="3600" class="btn btn-success">
                        ‚ûï 1 —á–∞—Å<br><small>(3,600 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="10800" class="btn btn-success">
                        ‚ûï 3 —á–∞—Å–∞<br><small>(10,800 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="21600" class="btn btn-success">
                        ‚ûï 6 —á–∞—Å–æ–≤<br><small>(21,600 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="43200" class="btn btn-success">
                        ‚ûï 12 —á–∞—Å–æ–≤<br><small>(43,200 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="86400" class="btn btn-success">
                        ‚ûï 1 –¥–µ–Ω—å<br><small>(86,400 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="259200" class="btn btn-success">
                        ‚ûï 3 –¥–Ω—è<br><small>(259,200 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="604800" class="btn btn-success">
                        ‚ûï 7 –¥–Ω–µ–π<br><small>(604,800 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="1209600" class="btn btn-success">
                        ‚ûï 14 –¥–Ω–µ–π<br><small>(1,209,600 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="2592000" class="btn btn-warning">
                        ‚ûï 30 –¥–Ω–µ–π<br><small>(2,592,000 —Å–µ–∫)</small>
                    </button>
                    <button type="submit" name="seconds" value="7776000" class="btn btn-warning">
                        ‚ûï 90 –¥–Ω–µ–π<br><small>(7,776,000 —Å–µ–∫)</small>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è -->
<div class="card">
    <div class="card-header">üéØ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</div>
    
    <div class="card-grid" style="grid-template-columns: 1fr 1fr;">
        <!-- –ü–æ —Å–µ–∫—É–Ω–¥–∞–º -->
        <div>
            <h4>–ü–æ —Å–µ–∫—É–Ω–¥–∞–º</h4>
            <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds">
                <div class="form-group">
                    <label for="custom_seconds">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥</label>
                    <input type="number" id="custom_seconds" name="seconds" class="form-control" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3600" min="1" max="31536000" required>
                    <small style="color: #6c757d;">–ú–∞–∫—Å–∏–º—É–º: 31,536,000 —Å–µ–∫ (1 –≥–æ–¥)</small>
                </div>
                <button type="submit" class="btn btn-warning">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—É–Ω–¥—ã</button>
            </form>
        </div>

        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ -->
        <div>
            <h4>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏</h4>
            <div style="display: grid; gap: 10px;">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                    <input type="number" id="calc_minutes" placeholder="–ú–∏–Ω—É—Ç—ã" min="0" class="form-control">
                    <span>–º–∏–Ω</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                    <input type="number" id="calc_hours" placeholder="–ß–∞—Å—ã" min="0" class="form-control">
                    <span>—á</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">
                    <input type="number" id="calc_days" placeholder="–î–Ω–∏" min="0" class="form-control">
                    <span>–¥–Ω</span>
                </div>
                <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                    <strong>–ò—Ç–æ–≥–æ —Å–µ–∫—É–Ω–¥: <span id="total_seconds">0</span></strong>
                </div>
                <button type="button" class="btn btn-secondary" onclick="copyCalculatedSeconds()">
                    üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–æ–ª–µ –≤—ã—à–µ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–Ω–æ–π –¥–∞—Ç—ã -->
<div class="card">
    <div class="card-header">üìÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ—á–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è</div>
    
    <form method="POST" action="/admin/users/{{ user.id }}/set-end-date">
        <div class="form-group">
            <label for="end_date">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏</label>
            <input type="datetime-local" id="end_date" name="end_date" class="form-control" required>
            <small style="color: #6c757d;">
                –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {{ user.subscription_end.strftime('%Y-%m-%dT%H:%M') }}
            </small>
        </div>
        
        <div style="display: flex; gap: 15px; align-items: center;">
            <button type="submit" class="btn btn-warning">üìÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É</button>
            <button type="button" class="btn btn-secondary" onclick="setDateFromNow(24)">+24 —á–∞—Å–∞ –æ—Ç —Å–µ–π—á–∞—Å</button>
            <button type="button" class="btn btn-secondary" onclick="setDateFromNow(168)">+7 –¥–Ω–µ–π –æ—Ç —Å–µ–π—á–∞—Å</button>
            <button type="button" class="btn btn-secondary" onclick="setDateFromNow(720)">+30 –¥–Ω–µ–π –æ—Ç —Å–µ–π—á–∞—Å</button>
        </div>
    </form>
</div>

<!-- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ -->
<div class="card">
    <div class="card-header">üéüÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</div>
    
    <form method="POST" action="/admin/users/{{ user.id }}/activate-promocode">
        <div class="form-group">
            <label for="promocode">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</label>
            <select id="promocode" name="promocode" class="form-control" required>
                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ --</option>
                {% for promo in available_promocodes %}
                <option value="{{ promo.code }}">
                    {{ promo.code }} - {{ promo.duration_seconds // 3600 }} —á–∞—Å–æ–≤ 
                    (–æ—Å—Ç–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∞—Ü–∏–π: {{ promo.max_activations - promo.current_activations }})
                </option>
                {% endfor %}
            </select>
        </div>
        
        {% if available_promocodes %}
            <button type="submit" class="btn btn-success">üéüÔ∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
        {% else %}
            <p style="color: #6c757d;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</p>
        {% endif %}
    </form>
</div>

<!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
<div class="card" style="border: 2px solid #28a745;">
    <div class="card-header" style="color: #28a745;">üîÆ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</div>
    <div id="preview_result" style="padding: 20px; text-align: center; color: #6c757d;">
        –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø—Ä–æ–¥–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
    </div>
</div>

<script>
// –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
function updateCalculator() {
    const minutes = parseInt(document.getElementById('calc_minutes').value) || 0;
    const hours = parseInt(document.getElementById('calc_hours').value) || 0;
    const days = parseInt(document.getElementById('calc_days').value) || 0;
    
    const totalSeconds = (minutes * 60) + (hours * 3600) + (days * 86400);
    document.getElementById('total_seconds').textContent = totalSeconds.toLocaleString();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    if (totalSeconds > 0) {
        showPreview(totalSeconds);
    }
}

function copyCalculatedSeconds() {
    const totalSeconds = document.getElementById('total_seconds').textContent.replace(/,/g, '');
    document.getElementById('custom_seconds').value = totalSeconds;
    showPreview(parseInt(totalSeconds));
}

function setDateFromNow(hours) {
    const now = new Date();
    now.setHours(now.getHours() + hours);
    
    const year = now.getFullYear();
    const month = ('0' + (now.getMonth() + 1)).slice(-2);
    const day = ('0' + now.getDate()).slice(-2);
    const hour = ('0' + now.getHours()).slice(-2);
    const minute = ('0' + now.getMinutes()).slice(-2);
    
    document.getElementById('end_date').value = `${year}-${month}-${day}T${hour}:${minute}`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
    showPreviewDate(now);
}

function showPreview(additionalSeconds) {
    const currentEnd = new Date('{{ user.subscription_end.isoformat() }}');
    const now = new Date();
    
    // –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞, —Å—á–∏—Ç–∞–µ–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    const baseDate = currentEnd > now ? currentEnd : now;
    const newEnd = new Date(baseDate.getTime() + (additionalSeconds * 1000));
    
    showPreviewDate(newEnd);
}

function showPreviewDate(newDate) {
    const formatted = newDate.toLocaleString('ru-RU', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    
    const now = new Date();
    const diffMs = newDate - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    
    document.getElementById('preview_result').innerHTML = `
        <strong style="color: #28a745;">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong><br>
        <span style="font-size: 18px; font-weight: bold;">${formatted}</span><br>
        <small style="color: #6c757d;">
            –≠—Ç–æ ${diffDays} –¥–Ω–µ–π –∏ ${diffHours} —á–∞—Å–æ–≤ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
        </small>
    `;
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    ['calc_minutes', 'calc_hours', 'calc_days'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateCalculator);
    });
    
    // –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ —Å–µ–∫—É–Ω–¥—ã
    document.getElementById('custom_seconds').addEventListener('input', function() {
        const seconds = parseInt(this.value);
        if (seconds > 0) {
            showPreview(seconds);
        }
    });
    
    // –¢–æ—á–Ω–∞—è –¥–∞—Ç–∞
    document.getElementById('end_date').addEventListener('change', function() {
        if (this.value) {
            const selectedDate = new Date(this.value);
            showPreviewDate(selectedDate);
        }
    });
    
    // –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è
    document.querySelectorAll('button[name="seconds"]').forEach(button => {
        button.addEventListener('mouseenter', function() {
            const seconds = parseInt(this.value);
            showPreview(seconds);
        });
    });
});

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const formData = new FormData(this);
        const seconds = formData.get('seconds');
        const endDate = formData.get('end_date');
        const promocode = formData.get('promocode');
        
        let message = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n\n';
        
        if (seconds) {
            const hours = Math.floor(seconds / 3600);
            const days = Math.floor(seconds / 86400);
            if (days > 0) {
                message += `–î–æ–±–∞–≤–∏—Ç—å ${days} –¥–Ω–µ–π (${seconds} —Å–µ–∫—É–Ω–¥) –∫ –ø–æ–¥–ø–∏—Å–∫–µ`;
            } else if (hours > 0) {
                message += `–î–æ–±–∞–≤–∏—Ç—å ${hours} —á–∞—Å–æ–≤ (${seconds} —Å–µ–∫—É–Ω–¥) –∫ –ø–æ–¥–ø–∏—Å–∫–µ`;
            } else {
                message += `–î–æ–±–∞–≤–∏—Ç—å ${seconds} —Å–µ–∫—É–Ω–¥ –∫ –ø–æ–¥–ø–∏—Å–∫–µ`;
            }
        } else if (endDate) {
            message += `–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è: ${new Date(endDate).toLocaleString('ru-RU')}`;
        } else if (promocode) {
            message += `–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥: ${promocode}`;
        }
        
        if (!confirm(message)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}