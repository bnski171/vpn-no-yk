{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - VPN Admin Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
    <div>
        <a href="/admin/users/add" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
        <a href="/admin/users/bulk-extend" class="btn btn-warning">‚è∞ –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ</a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
<div class="card" style="margin-bottom: 20px;">
    <div class="card-header">üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</div>
    <form method="GET" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label>–ü–æ–∏—Å–∫ –ø–æ Telegram ID / Email</label>
            <input type="text" name="search" class="form-control" value="{{ request.args.get('search', '') }}" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ email">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label>–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</label>
            <select name="status" class="form-control">
                <option value="">–í—Å–µ</option>
                <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                <option value="expired" {% if request.args.get('status') == 'expired' %}selected{% endif %}>–ò—Å—Ç–µ–∫—à–∏–µ</option>
            </select>
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label>–°–µ—Ä–≤–µ—Ä</label>
            <select name="server" class="form-control">
                <option value="">–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã</option>
                {% for server in servers %}
                <option value="{{ server.id }}" {% if request.args.get('server') == server.id|string %}selected{% endif %}>
                    {{ server.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <button type="submit" class="btn">üîç –ü–æ–∏—Å–∫</button>
    </form>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 25px;">
    <div class="stat-card">
        <div class="stat-value">{{ pagination.total }}</div>
        <div>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ users_stats.active_count }}</div>
        <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ users_stats.expired_count }}</div>
        <div>–ò—Å—Ç–µ–∫—à–∏—Ö</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ users_stats.expiring_soon }}</div>
        <div>–ò—Å—Ç–µ–∫–∞—é—Ç —Å–∫–æ—Ä–æ</div>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
<div class="card">
    <div class="card-header">–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ({{ pagination.page }} –∏–∑ {{ pagination.pages }})</div>
    
    {% if users %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–°–µ—Ä–≤–µ—Ä</th>
                    <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–æ–∑–¥–∞–Ω</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>
                        <strong>{{ user.telegram_id }}</strong><br>
                        <small style="color: #6c757d; font-family: monospace;">{{ user.email }}</small>
                    </td>
                    <td>
                        {% if user.server_name %}
                            <span class="status status-active">{{ user.server_name }}</span>
                        {% else %}
                            <span class="status status-warning">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ user.subscription_end.strftime('%d.%m.%Y %H:%M') }}</strong><br>
                        {% set time_left = user.time_left_seconds %}
                        {% if time_left > 0 %}
                            <small style="color: #28a745;">
                                {% if time_left > 86400 %}
                                    {{ (time_left // 86400)|int }} –¥–Ω
                                {% elif time_left > 3600 %}
                                    {{ (time_left // 3600)|int }} —á
                                {% else %}
                                    {{ (time_left // 60)|int }} –º–∏–Ω
                                {% endif %}
                            </small>
                        {% else %}
                            <small style="color: #dc3545;">–ò—Å—Ç–µ–∫–ª–∞</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_subscription_active %}
                            <span class="status status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% else %}
                            <span class="status status-expired">–ò—Å—Ç–µ–∫–ª–∞</span>
                        {% endif %}
                    </td>
                    <td>
                        <span data-timestamp="{{ user.created_at.isoformat() }}">
                            {{ user.created_at.strftime('%d.%m.%Y') }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <a href="/admin/users/{{ user.id }}" class="btn" style="padding: 6px 12px; font-size: 12px;">
                                üìã –î–µ—Ç–∞–ª–∏
                            </a>
                            <a href="/admin/users/{{ user.id }}/extend" class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">
                                ‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å
                            </a>
                            </a>
                            <button type="button" id="pay-btn" data-user-id="{{ user.id }}"  class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
                            <button type="button" id="resufe-btn" data-user-id="{{ user.id }}"  class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>

                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<!--  —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã  -->
    <script>
    // —Å–æ–∑–¥–∞—ë—Ç –æ–ø–ª–∞—Ç—É
    document.getElementById('pay-btn').addEventListener('click', async function(e) {
        try {
            const btn = e.currentTarget;
            const user_id = btn.getAttribute('data-user-id');
            const return_url = window.location.href;

            const response = await fetch('/api/payments/pay-link', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    duration: 30, 
                    amount: 500,
                    user_id: user_id,
                    return_url: return_url,
                })
            });
            const data = await response.json();
            if (data.confirmation_url) {
                window.open(data.confirmation_url, '_blank');
            } else {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã');
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err);
        }
    });
    
    // –æ—Ç–º–µ–Ω—è–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É
    document.getElementById('resufe-btn').addEventListener('click', async function(e) {
        try {
            const btn = e.currentTarget;
            const user_id = btn.getAttribute('data-user-id');

            const response = await fetch(`/api/payments/refuse-recurrent/${user_id}`, {
                method: 'GET',
              
            });
           const data = await response.json();
            if (data.success && data.is_refuse) {
                alert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞');
            } else if (data.success) {
                alert('–†–∞–∑—Ä–µ—à–µ–Ω–æ –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–µ');
            } else {
                console.log(data);
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É');
            }
        } catch (err) {
            alert('–û—à–∏–±–∫–∞: ' + err);
        }
    });
</script>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
            <a href="{{ url_for(request.endpoint, page=pagination.prev_num, **request.args) }}">&laquo; –ü—Ä–µ–¥</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                    <a href="{{ url_for(request.endpoint, page=page_num, **request.args) }}">{{ page_num }}</a>
                {% else %}
                    <span class="current">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <a href="{{ url_for(request.endpoint, page=pagination.next_num, **request.args) }}">–°–ª–µ–¥ &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <h3>üîç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ <a href="/admin/users/add">–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a></p>
    </div>
    {% endif %}
</div>
{% endblock %}

