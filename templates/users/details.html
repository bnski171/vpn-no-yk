{% extends "base.html" %}

{% block title %}{{ user.telegram_id }} - –î–µ—Ç–∞–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ user.telegram_id }}</h2>
    <div>
        <a href="/admin/users" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <a href="/admin/users/{{ user.id }}/extend" class="btn btn-warning">‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="card-grid" style="grid-template-columns: 1fr 1fr;">
    <div class="card">
        <div class="card-header">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>Telegram ID:</strong><br>
                <span style="font-family: monospace; font-size: 16px;">{{ user.telegram_id }}</span>
            </div>
            <div>
                <strong>Email:</strong><br>
                <span style="font-family: monospace; color: #6c757d;">{{ user.email }}</span>
            </div>
            <div>
                <strong>UUID:</strong><br>
                <div class="copy-field">
                    <input type="text" value="{{ user.uuid }}" readonly class="form-control" style="font-family: monospace; font-size: 12px;">
                    <button class="btn" onclick="copyToClipboard('{{ user.uuid }}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            <div>
                <strong>–°–µ—Ä–≤–µ—Ä:</strong><br>
                {% if user.server_name %}
                    <span class="status status-active">{{ user.server_name }}</span><br>
                    <small>{{ user.server_domain }}</small>
                {% else %}
                    <span class="status status-warning">–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                {% endif %}
            </div>
            <div>
                <strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong><br>
                {{ user.created_at.strftime('%d.%m.%Y %H:%M:%S') }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">‚è∞ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</div>
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong><br>
                <span style="font-size: 18px; font-weight: bold;">
                    {{ user.subscription_end.strftime('%d.%m.%Y %H:%M:%S') }}
                </span>
            </div>
            <div>
                <strong>–°—Ç–∞—Ç—É—Å:</strong><br>
                {% if user.is_subscription_active %}
                    <span class="status status-active">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span>
                {% else %}
                    <span class="status status-expired">‚ùå –ò—Å—Ç–µ–∫–ª–∞</span>
                {% endif %}
            </div>
            <div>
                <strong>–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏:</strong><br>
                {% set time_left = user.time_left_seconds %}
                {% if time_left > 0 %}
                    <span style="color: #28a745; font-weight: bold;">
                        {{ time_left // 86400 }} –¥–Ω {{ (time_left % 86400) // 3600 }} —á {{ ((time_left % 3600) // 60) }} –º–∏–Ω
                    </span>
                {% else %}
                    <span style="color: #dc3545; font-weight: bold;">–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</span>
                {% endif %}
            </div>
            <div>
                <strong>–í—Å–µ–≥–æ —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å:</strong><br>
                <span style="font-family: monospace; font-size: 16px;">
                    {% if time_left > 0 %}{{ time_left }}{% else %}0{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- VPN –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è -->
<div class="card">
    <div class="card-header">üîê VPN –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
    
    {% if vpn_config %}
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        <div>
            <h4>üì± VLESS –ö–ª—é—á</h4>
            <div class="copy-field" style="margin-bottom: 20px;">
                <input type="text" value="{{ vpn_config }}" readonly class="form-control" style="font-family: monospace; font-size: 11px;">
                <button class="btn btn-success" onclick="copyToClipboard('{{ vpn_config }}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                <small><strong>üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></small><br>
                <small>1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á –≤—ã—à–µ</small><br>
                <small>2. –û—Ç–∫—Ä–æ–π—Ç–µ VPN –∫–ª–∏–µ–Ω—Ç (V2rayNG, Shadowrocket –∏ —Ç.–¥.)</small><br>
                <small>3. –î–æ–±–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ "–ò–º–ø–æ—Ä—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞"</small>
            </div>
        </div>
        
        <div style="text-align: center;">
            <h4>üì± QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h4>
            <div id="qr-code" style="margin: 20px 0;"></div>
            <button class="btn btn-secondary" onclick="generateQR()">üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥</button>
        </div>
    </div>
    
    {% else %}
    <div class="alert alert-danger">
        <h4>‚ùå VPN –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h4>
        <p>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</p>
        <ul>
            <li>–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞</li>
            <li>–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</li>
            <li>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä</li>
        </ul>
        {% if not user.is_subscription_active %}
        <a href="/admin/users/{{ user.id }}/extend" class="btn btn-warning">‚è∞ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- –ë—ã—Å—Ç—Ä–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π -->
<div class="card">
    <div class="card-header">‚ö° –ë—ã—Å—Ç—Ä–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π</div>
    
    <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>‚ûï 1 —á–∞—Å</strong>
                <button type="submit" name="seconds" value="3600" class="btn btn-success" style="margin-top: 10px;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>‚ûï 1 –¥–µ–Ω—å</strong>
                <button type="submit" name="seconds" value="86400" class="btn btn-success" style="margin-top: 10px;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>‚ûï 7 –¥–Ω–µ–π</strong>
                <button type="submit" name="seconds" value="604800" class="btn btn-success" style="margin-top: 10px;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
        
        <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds" style="display: contents;">
            <div class="card" style="margin: 0; background: #f8f9fa;">
                <strong>‚ûï 30 –¥–Ω–µ–π</strong>
                <button type="submit" name="seconds" value="2592000" class="btn btn-success" style="margin-top: 10px;">
                    –î–æ–±–∞–≤–∏—Ç—å
                </button>
            </div>
        </form>
    </div>
    
    <!-- –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥ -->
    <form method="POST" action="/admin/users/{{ user.id }}/extend-seconds" style="margin-top: 20px;">
        <div class="form-group">
            <label>üéØ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥:</label>
            <div style="display: flex; gap: 10px; align-items: end;">
                <input type="number" name="seconds" class="form-control" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥" min="1" style="max-width: 200px;">
                <button type="submit" class="btn btn-warning">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—É–Ω–¥—ã</button>
            </div>
            <small style="color: #6c757d;">–ü—Ä–∏–º–µ—Ä—ã: 3600 = 1 —á–∞—Å, 86400 = 1 –¥–µ–Ω—å, 604800 = 7 –¥–Ω–µ–π</small>
        </div>
    </form>
</div>

<!-- –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<div class="card">
    <div class="card-header">üìù –ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
    {% if user_activity %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    <th>–î–µ—Ç–∞–ª–∏</th>
                </tr>
            </thead>
            <tbody>
                {% for activity in user_activity %}
                <tr>
                    <td>{{ activity.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</td>
                    <td>
                        {% if activity.action == 'USER_CREATED' %}
                            <span class="status status-active">üë§ –°–æ–∑–¥–∞–Ω</span>
                        {% elif activity.action == 'SUBSCRIPTION_EXTENDED' %}
                            <span class="status status-active">‚è∞ –ü—Ä–æ–¥–ª–µ–Ω–∏–µ</span>
                        {% elif activity.action == 'VPN_ACTIVATED' %}
                            <span class="status status-active">üîê –ê–∫—Ç–∏–≤–∞—Ü–∏—è VPN</span>
                        {% elif activity.action == 'VPN_DEACTIVATED' %}
                            <span class="status status-expired">‚ùå –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è VPN</span>
                        {% elif activity.action == 'PROMOCODE_ACTIVATED' %}
                            <span class="status status-warning">üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥</span>
                        {% else %}
                            <span class="status">{{ activity.action }}</span>
                        {% endif %}
                    </td>
                    <td>{{ activity.details }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>–ò—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—É—Å—Ç–∞</p>
    {% endif %}
</div>

<!-- –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ -->
<div class="card" style="border: 2px solid #dc3545;">
    <div class="card-header" style="color: #dc3545;">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div>
    <div style="display: flex; gap: 15px;">
        <form method="POST" action="/admin/users/{{ user.id }}/delete" onsubmit="return confirmDelete('–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
            <button type="submit" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </form>
        
        <form method="POST" action="/admin/users/{{ user.id }}/reset-subscription">
            <button type="submit" class="btn btn-danger" onclick="return confirmDelete('–≠—Ç–æ –æ–±–Ω—É–ª–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')">
                ‚è∞ –û–±–Ω—É–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
            </button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
function generateQR() {
    const vpnConfig = '{{ vpn_config|safe }}';
    const qrContainer = document.getElementById('qr-code');
    
    if (vpnConfig) {
        qrContainer.innerHTML = '';
        QRCode.toCanvas(qrContainer, vpnConfig, {
            width: 256,
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        }, function (error) {
            if (error) {
                qrContainer.innerHTML = '<p style="color: #dc3545;">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞</p>';
            }
        });
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    {% if vpn_config %}
    generateQR();
    {% endif %}
});
</script>
{% endblock %}