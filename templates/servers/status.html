{% extends "base.html" %}

{% block title %}{{ server.name }} - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ {{ server.name }}</h2>
    <div>
        <a href="/admin/servers" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
        <button onclick="refreshStatus()" class="btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <a href="/admin/servers/{{ server.id }}/edit" class="btn btn-warning">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</a>
    </div>
</div>

<!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
<div class="card-grid" style="grid-template-columns: 1fr 1fr;">
    <div class="card">
        <div class="card-header">üñ•Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ</div>
        <div style="display: grid; gap: 15px;">
            <div>
                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>
                <span style="font-size: 16px;">{{ server.name }}</span>
            </div>
            <div>
                <strong>–î–æ–º–µ–Ω:</strong><br>
                <span style="font-family: monospace;">{{ server.domain }}</span>
            </div>
            <div>
                <strong>API URL:</strong><br>
                <span style="font-family: monospace; font-size: 12px; color: #6c757d;">{{ server.api_url }}</span>
            </div>
            <div>
                <strong>–°—Ç–∞—Ç—É—Å:</strong><br>
                {% if server.is_active %}
                    <span class="status status-active">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                {% else %}
                    <span class="status status-expired">‚ùå –û—Ç–∫–ª—é—á–µ–Ω</span>
                {% endif %}
            </div>
            <div>
                <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</strong><br>
                <span style="font-size: 18px; font-weight: bold; color: #007bff;">{{ server.user_count }}</span>
            </div>
            <div>
                <strong>–°–æ–∑–¥–∞–Ω:</strong><br>
                {{ server.created_at.strftime('%d.%m.%Y %H:%M:%S') }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">üåê –°–µ—Ç–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div style="display: grid; gap: 15px;">
            {% if status.get('server', {}).get('ip') %}
                <div>
                    <strong>IPv4:</strong><br>
                    <span style="font-family: monospace;">{{ status.server.ip.get('ipv4', '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ') }}</span>
                </div>
                <div>
                    <strong>IPv6:</strong><br>
                    <span style="font-family: monospace;">{{ status.server.ip.get('ipv6', '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω') }}</span>
                </div>
            {% endif %}
            <div>
                <strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</strong><br>
                <span id="lastCheck">{{ current_time.strftime('%d.%m.%Y %H:%M:%S') }}</span>
            </div>
            <div>
                <strong>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong><br>
                <span id="responseTime">
                    {% if response_time %}
                        {{ response_time }} –º—Å
                    {% else %}
                        –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<div class="card">
    <div class="card-header">üîå –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
    
    {% if status.get('error') %}
        <div style="padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h4 style="color: #721c24; margin-bottom: 10px;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h4>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ status.error }}</p>
            
            <div style="margin-top: 15px;">
                <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong>
                <ul style="margin-top: 8px;">
                    <li>–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω</li>
                    <li>–ù–µ–≤–µ—Ä–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API</li>
                    <li>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º</li>
                    <li>–ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</li>
                </ul>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="testConnection()" class="btn btn-warning">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                <button onclick="pingServer()" class="btn btn-secondary">üì° Ping —Å–µ—Ä–≤–µ—Ä–∞</button>
            </div>
        </div>
    {% else %}
        <div style="padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω</h4>
            <p>–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</p>
        </div>
    {% endif %}
</div>

<!-- Xray —Å—Ç–∞—Ç—É—Å -->
{% if status.get('xray') %}
<div class="card">
    <div class="card-header">üîê –°—Ç–∞—Ç—É—Å Xray</div>
    
    <div class="card-grid" style="grid-template-columns: 1fr 1fr;">
        <div>
            <div style="display: grid; gap: 15px;">
                <div>
                    <strong>–°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã:</strong><br>
                    {% if status.xray.get('running', {}).get('service_active') %}
                        <span class="status status-active">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span>
                    {% else %}
                        <span class="status status-expired">‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
                    {% endif %}
                </div>
                <div>
                    <strong>–í–µ—Ä—Å–∏—è:</strong><br>
                    <span style="font-family: monospace;">{{ status.xray.get('version', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }}</span>
                </div>
                <div>
                    <strong>–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç–æ–≤:</strong><br>
                    {% if status.xray.get('running', {}).get('port_listening') %}
                        <span class="status status-active">‚úÖ –ü–æ—Ä—Ç—ã –æ—Ç–∫—Ä—ã—Ç—ã</span>
                    {% else %}
                        <span class="status status-expired">‚ùå –ü–æ—Ä—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</span>
                    {% endif %}
                </div>
                <div>
                    <strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong><br>
                    {% if status.xray.get('config_valid') %}
                        <span class="status status-active">‚úÖ –í–∞–ª–∏–¥–Ω–∞</span>
                    {% else %}
                        <span class="status status-expired">‚ùå –û—à–∏–±–∫–∞</span>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div>
            {% if status.xray.get('errors') %}
                <div style="margin-bottom: 15px;">
                    <strong style="color: #dc3545;">‚ùå –û—à–∏–±–∫–∏:</strong>
                    <ul style="margin-top: 5px; font-size: 14px;">
                        {% for error in status.xray.errors %}
                        <li style="color: #dc3545;">{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if status.xray.get('warnings') %}
                <div>
                    <strong style="color: #ffc107;">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</strong>
                    <ul style="margin-top: 5px; font-size: 14px;">
                        {% for warning in status.xray.warnings %}
                        <li style="color: #856404;">{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if not status.xray.get('errors') and not status.xray.get('warnings') %}
                <div style="padding: 15px; background: #e8f5e8; border-radius: 8px; text-align: center;">
                    <strong style="color: #28a745;">üéâ –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ!</strong><br>
                    <small>Xray —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫</small>
                </div>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 20px; display: flex; gap: 15px;">
        <button onclick="restartXray()" class="btn btn-warning">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Xray</button>
        <button onclick="reloadXrayConfig()" class="btn btn-secondary">üìÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥</button>
        <button onclick="showXrayLogs()" class="btn">üìã –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏</button>
    </div>
</div>
{% endif %}

<!-- SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç -->
{% if status.get('certificate') %}
<div class="card">
    <div class="card-header">üîí SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</div>
    
    {% if status.certificate.get('status') %}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <div style="display: grid; gap: 15px;">
                    <div>
                        <strong>–°—Ç–∞—Ç—É—Å:</strong><br>
                        {% if status.certificate.get('is_valid') %}
                            <span class="status status-active">‚úÖ –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</span>
                        {% else %}
                            <span class="status status-expired">‚ùå –ò—Å—Ç–µ–∫</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>–î–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –¥–æ:</strong><br>
                        <span style="font-family: monospace;">{{ status.certificate.get('not_valid_after', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') }}</span>
                    </div>
                    <div>
                        <strong>–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:</strong><br>
                        {% set days_left = status.certificate.get('days_left') %}
                        {% if days_left is not none %}
                            {% if days_left > 30 %}
                                <span style="color: #28a745; font-weight: bold;">{{ days_left }} –¥–Ω–µ–π</span>
                            {% elif days_left > 7 %}
                                <span style="color: #ffc107; font-weight: bold;">{{ days_left }} –¥–Ω–µ–π</span>
                            {% else %}
                                <span style="color: #dc3545; font-weight: bold;">{{ days_left }} –¥–Ω–µ–π</span>
                            {% endif %}
                        {% else %}
                            <span>–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div>
                {% if days_left is not none and days_left < 30 %}
                    <div style="padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!</strong><br>
                        <small>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ.</small>
                        
                        <div style="margin-top: 10px;">
                            <button onclick="renewCertificate()" class="btn btn-warning">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</button>
                        </div>
                    </div>
                {% else %}
                    <div style="padding: 15px; background: #e8f5e8; border-radius: 8px; text-align: center;">
                        <strong style="color: #28a745;">üîí –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤ –ø–æ—Ä—è–¥–∫–µ</strong><br>
                        <small>–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</small>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div style="padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
            <h4 style="color: #721c24;">‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</h4>
            <p>{{ status.certificate.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞') }}</p>
        </div>
    {% endif %}
</div>
{% endif %}

<!-- –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
{% if status.get('system') %}
<div class="card">
    <div class="card-header">üíª –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
    
    <div class="card-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        {% if status.system.get('cpu') %}
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: bold; color: #007bff;">
                {{ status.system.cpu.get('percent', 'N/A') }}%
            </div>
            <div style="color: #6c757d;">–ó–∞–≥—Ä—É–∑–∫–∞ CPU</div>
            <small>({{ status.system.cpu.get('count', 'N/A') }} —è–¥–µ—Ä)</small>
        </div>
        {% endif %}
        
        {% if status.system.get('memory') %}
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                {{ status.system.memory.get('percent', 'N/A') }}%
            </div>
            <div style="color: #6c757d;">–ü–∞–º—è—Ç—å</div>
            <small>{{ status.system.memory.get('used', 'N/A') }} / {{ status.system.memory.get('total', 'N/A') }} –ú–ë</small>
        </div>
        {% endif %}
        
        {% if status.system.get('disk') %}
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">
                {{ status.system.disk.get('percent', 'N/A') }}%
            </div>
            <div style="color: #6c757d;">–î–∏—Å–∫</div>
            <small>{{ status.system.disk.get('used', 'N/A') }} / {{ status.system.disk.get('total', 'N/A') }} –ì–ë</small>
        </div>
        {% endif %}
        
        {% if status.system.get('network') %}
        <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <div style="font-size: 16px; font-weight: bold; color: #6f42c1;">
                ‚Üë{{ status.system.network.get('bytes_sent', 'N/A') }}–ú–ë<br>
                ‚Üì{{ status.system.network.get('bytes_recv', 'N/A') }}–ú–ë
            </div>
            <div style="color: #6c757d;">–°–µ—Ç—å</div>
        </div>
        {% endif %}
    </div>
    
    {% if status.system.get('uptime') %}
    <div style="margin-top: 20px; text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
        <strong>‚è±Ô∏è –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞:</strong> {{ status.system.uptime }}
    </div>
    {% endif %}
</div>
{% endif %}

<!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ -->
<div class="card">
    <div class="card-header">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ({{ server.user_count }})</div>
    
    {% if server_users %}
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Telegram ID</th>
                    <th>Email</th>
                    <th>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in server_users %}
                <tr>
                    <td>{{ user.telegram_id }}</td>
                    <td style="font-family: monospace; font-size: 12px;">{{ user.email }}</td>
                    <td>{{ user.subscription_end.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td>
                        {% if user.is_subscription_active %}
                            <span class="status status-active">–ê–∫—Ç–∏–≤–Ω–∞</span>
                        {% else %}
                            <span class="status status-expired">–ò—Å—Ç–µ–∫–ª–∞</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/admin/users/{{ user.id }}" class="btn" style="padding: 4px 8px; font-size: 12px;">
                            –ü–æ–¥—Ä–æ–±–Ω–æ
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div style="text-align: center; padding: 40px; color: #6c757d;">
        <h4>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
        <p>–ù–∞ —ç—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
        <a href="/admin/users/add" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</a>
    </div>
    {% endif %}
</div>

<script>
async function refreshStatus() {
    const button = event.target;
    const originalText = button.textContent;
    
    button.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/admin/servers/{{ server.id }}/refresh-status`, { method: 'POST' });
        if (response.ok) {
            location.reload();
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

async function testConnection() {
    const button = event.target;
    const originalText = button.textContent;
    
    button.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/admin/servers/{{ server.id }}/test-connection`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!\n\n–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ' + (result.response_time || 'N/A'));
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:\n\n' + result.error);
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

async function pingServer() {
    const button = event.target;
    const originalText = button.textContent;
    
    button.textContent = 'üì° Ping...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/admin/servers/{{ server.id }}/ping`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert(`üì° Ping —Ä–µ–∑—É–ª—å—Ç–∞—Ç:\n\n–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${result.ping_time}–º—Å\n–°—Ç–∞—Ç—É—Å: ${result.status}`);
        } else {
            alert('‚ùå Ping –Ω–µ—É–¥–∞—á–µ–Ω:\n\n' + result.error);
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ ping: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

async function restartXray() {
    if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Xray? –≠—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–µ—Ä–≤–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.')) return;
    
    const button = event.target;
    const originalText = button.textContent;
    
    button.textContent = '‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';
    button.disabled = true;
    
    try {
        const response = await fetch(`/admin/servers/{{ server.id }}/restart-xray`, { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Xray –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Xray:\n\n' + result.error);
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

function reloadXrayConfig() {
    alert('–§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
}

function showXrayLogs() {
    window.open(`/admin/servers/{{ server.id }}/logs/xray`, '_blank');
}

function renewCertificate() {
    if (!confirm('–û–±–Ω–æ–≤–∏—Ç—å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.')) return;
    
    alert('–§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
function updateLastCheck() {
    document.getElementById('lastCheck').textContent = new Date().toLocaleString('ru-RU');
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(() => {
    if (!document.hidden) {
        updateLastCheck();
    }
}, 30000);
</script>
{% endblock %}