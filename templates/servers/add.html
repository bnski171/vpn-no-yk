{% extends "base.html" %}

{% block title %}–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä - VPN Admin Panel{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å VPN —Å–µ—Ä–≤–µ—Ä</h2>
    <a href="/admin/servers" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div class="card-grid" style="grid-template-columns: 1fr 1fr;">
    <div class="card">
        <div class="card-header">üñ•Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞</div>
        
        <form method="POST" action="/admin/servers/add" id="serverForm">
            <div class="form-group">
                <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ *</label>
                <input type="text" id="name" name="name" class="form-control" required 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: VPN-Server-DE-01" maxlength="50">
                <small style="color: #6c757d;">–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞</small>
            </div>
            
            <div class="form-group">
                <label for="domain">–î–æ–º–µ–Ω *</label>
                <input type="text" id="domain" name="domain" class="form-control" required 
                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: server1.example.com" pattern="[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}">
                <small style="color: #6c757d;">–î–æ–º–µ–Ω –∏–ª–∏ IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞</small>
            </div>
            
            <div class="form-group">
                <label for="api_url">API URL *</label>
                <input type="url" id="api_url" name="api_url" class="form-control" required 
                       placeholder="https://server1.example.com:2053">
                <small style="color: #6c757d;">URL –¥–ª—è API –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</small>
            </div>
            
            <div class="form-group">
                <label for="api_token">API —Ç–æ–∫–µ–Ω *</label>
                <div style="position: relative;">
                    <input type="password" id="api_token" name="api_token" class="form-control" required 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" minlength="10">
                    <button type="button" onclick="togglePassword()" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; cursor: pointer;">
                        üëÅÔ∏è
                    </button>
                </div>
                <small style="color: #6c757d;">–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –∫ API –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º</small>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button type="submit" class="btn btn-success">‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
                <button type="button" onclick="testConnection()" class="btn btn-warning">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</button>
                <button type="reset" class="btn btn-secondary">üîÑ –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
            </div>
        </form>
    </div>
    
    <div class="card">
        <div class="card-header">üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</div>
        
        <div style="display: grid; gap: 20px;">
            <div style="padding: 15px; background: #e3f2fd; border-radius: 8px;">
                <strong>üìã –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞</strong><br>
                <small>
                    1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (3x-ui, x-ui –∏ —Ç.–¥.)<br>
                    2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ HTTPS<br>
                    3. –ü–æ–ª—É—á–∏—Ç–µ API —Ç–æ–∫–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–∞–Ω–µ–ª–∏
                </small>
            </div>
            
            <div style="padding: 15px; background: #f3e5f5; border-radius: 8px;">
                <strong>üîß –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API</strong><br>
                <small>
                    1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º<br>
                    2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API<br>
                    3. –í–∫–ª—é—á–∏—Ç–µ API –¥–æ—Å—Ç—É–ø<br>
                    4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                </small>
            </div>
            
            <div style="padding: 15px; background: #e8f5e8; border-radius: 8px;">
                <strong>üîó –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</strong><br>
                <small>
                    1. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã<br>
                    2. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"<br>
                    3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä<br>
                    4. –°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
                </small>
            </div>
            
            <div style="padding: 15px; background: #fff3e0; border-radius: 8px;">
                <strong>‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</strong><br>
                <small>
                    ‚Ä¢ Ubuntu 20.04+ –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –û–°<br>
                    ‚Ä¢ –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã: 443, 80, 2053<br>
                    ‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è<br>
                    ‚Ä¢ –í–∞–ª–∏–¥–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
                </small>
            </div>
        </div>
    </div>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
<div id="testResult" class="card" style="display: none;">
    <div class="card-header">üîç –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
    <div id="testResultContent"></div>
</div>

<!-- –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã -->
<div class="card">
    <div class="card-header">üìù –ë—ã—Å—Ç—Ä–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong>3X-UI –ø–∞–Ω–µ–ª—å</strong><br>
            <small>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è 3X-UI</small><br>
            <button type="button" onclick="fillTemplate('3x-ui')" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                –ó–∞–ø–æ–ª–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
            </button>
        </div>
        
        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong>X-UI –ø–∞–Ω–µ–ª—å</strong><br>
            <small>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è X-UI</small><br>
            <button type="button" onclick="fillTemplate('x-ui')" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                –ó–∞–ø–æ–ª–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
            </button>
        </div>
        
        <div style="padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong>Marzban –ø–∞–Ω–µ–ª—å</strong><br>
            <small>–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Marzban</small><br>
            <button type="button" onclick="fillTemplate('marzban')" class="btn btn-secondary" style="margin-top: 10px; width: 100%;">
                –ó–∞–ø–æ–ª–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
            </button>
        </div>
    </div>
</div>

<script>
function togglePassword() {
    const input = document.getElementById('api_token');
    const button = event.target;
    
    if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
    } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
    }
}

async function testConnection() {
    const form = document.getElementById('serverForm');
    const formData = new FormData(form);
    
    const testButton = event.target;
    const originalText = testButton.textContent;
    
    testButton.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    testButton.disabled = true;
    
    const resultDiv = document.getElementById('testResult');
    const resultContent = document.getElementById('testResultContent');
    
    try {
        const response = await fetch('/admin/servers/test-connection', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        resultDiv.style.display = 'block';
        
        if (result.success) {
            resultContent.innerHTML = `
                <div style="padding: 20px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 15px;">‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!</h4>
                    <div style="display: grid; gap: 10px;">
                        <div><strong>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:</strong> ${result.server_info.status || '–ê–∫—Ç–∏–≤–µ–Ω'}</div>
                        <div><strong>–í–µ—Ä—Å–∏—è Xray:</strong> ${result.server_info.xray_version || '–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è...'}</div>
                        <div><strong>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</strong> ${result.response_time || 'N/A'}</div>
                        ${result.server_info.uptime ? `<div><strong>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</strong> ${result.server_info.uptime}</div>` : ''}
                    </div>
                    <p style="margin-top: 15px; color: #155724;">
                        üéâ –°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é! –í—ã –º–æ–∂–µ—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
                    </p>
                </div>
            `;
        } else {
            resultContent.innerHTML = `
                <div style="padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                    <h4 style="color: #721c24; margin-bottom: 15px;">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h4>
                    <div style="margin-bottom: 15px;">
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${result.error}
                    </div>
                    <div style="background: #fff; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                        ${result.details || '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>–í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:</strong>
                        <ul style="margin-top: 8px;">
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å URL –∏ –ø–æ—Ä—Ç–∞</li>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</li>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞</li>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω</li>
                        </ul>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        resultContent.innerHTML = `
            <div style="padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                <h4 style="color: #721c24;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞</h4>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: ${error.message}</p>
            </div>
        `;
        resultDiv.style.display = 'block';
    } finally {
        testButton.textContent = originalText;
        testButton.disabled = false;
    }
}

function fillTemplate(type) {
    const domain = prompt('–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: server1.example.com):');
    if (!domain) return;
    
    const templates = {
        '3x-ui': {
            name: `3X-UI-${domain.split('.')[0]}`,
            api_url: `https://${domain}:2053`,
            placeholder_token: '–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ 3X-UI ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí API'
        },
        'x-ui': {
            name: `X-UI-${domain.split('.')[0]}`,
            api_url: `https://${domain}:54321`,
            placeholder_token: '–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ X-UI ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí API'
        },
        'marzban': {
            name: `Marzban-${domain.split('.')[0]}`,
            api_url: `https://${domain}:8000`,
            placeholder_token: '–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –ø–∞–Ω–µ–ª–∏ Marzban ‚Üí Admin ‚Üí API Token'
        }
    };
    
    const template = templates[type];
    if (!template) return;
    
    document.getElementById('name').value = template.name;
    document.getElementById('domain').value = domain;
    document.getElementById('api_url').value = template.api_url;
    document.getElementById('api_token').placeholder = template.placeholder_token;
    
    alert(`–®–∞–±–ª–æ–Ω ${type.toUpperCase()} –∑–∞–ø–æ–ª–Ω–µ–Ω! –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–≤–µ—Å—Ç–∏ API —Ç–æ–∫–µ–Ω.`);
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.getElementById('serverForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const domain = document.getElementById('domain').value.trim();
    const apiUrl = document.getElementById('api_url').value.trim();
    const apiToken = document.getElementById('api_token').value.trim();
    
    if (!name || !domain || !apiUrl || !apiToken) {
        e.preventDefault();
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }
    
    if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
        e.preventDefault();
        alert('API URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://');
        return;
    }
    
    if (apiToken.length < 10) {
        e.preventDefault();
        alert('API —Ç–æ–∫–µ–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π. –ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤.');
        return;
    }
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ API URL –ø—Ä–∏ –≤–≤–æ–¥–µ –¥–æ–º–µ–Ω–∞
document.getElementById('domain').addEventListener('input', function() {
    const domain = this.value.trim();
    const apiUrlField = document.getElementById('api_url');
    
    if (domain && !apiUrlField.value) {
        apiUrlField.value = `https://${domain}:2053`;
    }
});
</script>
{% endblock %}